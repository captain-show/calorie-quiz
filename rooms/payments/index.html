<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Form</title>
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Facebook Pixel Code -->
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '711716411890573');
      fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id=711716411890573&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Facebook Pixel Code -->
    
    <!-- Mixpanel Code -->
    <script type="text/javascript">
      (function(c,a){if(!a.__SV){var b=window;try{var d,m,j,k=b.location,f=k.hash;d=function(a,b){return(m=a.match(RegExp(b+"=([^&]*)")))?m[1]:null};f&&d(f,"state")&&(j=JSON.parse(decodeURIComponent(d(f,"state"))),"mpeditor"===j.action&&(b.sessionStorage.setItem("_mpcehash",f),history.replaceState(j.desiredHash||"",c.title,k.pathname+k.search)))}catch(n){}var l,h;window.mixpanel=a;a._i=[];a.init=function(b,d,g){function c(b,i){var a=i.split(".");2==a.length&&(b=b[a[0]],i=a[1]);b[i]=function(){b.push([i].concat(Array.prototype.slice.call(arguments,0)))}}var e=a;"undefined"!==typeof g?e=a[g]=[]:g="mixpanel";e.people=e.people||[];e.toString=function(b){var a="mixpanel";"mixpanel"!==g&&(a+="."+g);b||(a+=" (stub)");return a};e.people.toString=function(){return e.toString(1)+".people (stub)"};l="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_tracking clear_opt_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");for(h=0;h<l.length;h++)c(e,l[h]);a._i.push([b,d,g])};a.__SV=1.2;b=c.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===c.location.protocol&&"//cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js";d=c.getElementsByTagName("script")[0];d.parentNode.insertBefore(b,d)}})(document,window.mixpanel||[]);
      mixpanel.init('9b20d126e4950a5648bd80433f80af18');
    </script>
    <!-- End Mixpanel Code -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: white;
            max-width: 450px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .payment-container {
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            overflow: visible;
        }

        .payment-header {
            background: white;
            color: #212529;
            padding: 20px;
            text-align: center;
        }

        .payment-header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .total-section {
            background: #f8f9fa;
            padding: 16px 20px 16px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 16px;
        }

        .total-label {
            font-size: 16px;
            color: #212529;
            font-weight: 500;
        }

        .total-amount {
            font-size: 16px;
            font-weight: 700;
            color: #212529;
        }

        .payment-methods {
            padding: 0;
            background: transparent;
        }

        .payment-method {
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .payment-method:last-child {
            margin-bottom: 0;
        }

        .payment-method.active {
            border-color: #ff6b35;
        }

        .payment-method-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: background-color 0.2s;
        }

        .payment-method-header:hover {
            background-color: #e9ecef;
            border-radius: 12px;
        }

        .payment-method-title {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
            flex: 1;
        }

        .payment-method-badge {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
            display: flex;
            align-items: center;
        }

        .payment-method-radio {
            width: 20px;
            height: 20px;
            border: 2px solid #dee2e6;
            border-radius: 50%;
            background: white;
            position: relative;
            transition: all 0.2s;
        }

        .payment-method-radio.active {
            border-color: #ff6b35;
            background: #ff6b35;
        }

        .payment-method-radio.active::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }

        .payment-method-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            padding: 0;
            border-radius: 0 0 12px 12px;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
        }

        .payment-method-content.active {
            max-height: 500px;
            opacity: 1;
            padding: 20px;
        }

        .guarantee-section {
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 20px;
            padding: 20px;
        }

        .guarantee-title {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 12px;
            text-align: left;
        }

        .guarantee-text {
            font-size: 14px;
            color: #212529;
            line-height: 1.5;
            text-align: left;
            margin-bottom: 16px;
        }

        .guarantee-divider {
            height: 1px;
            background: #dee2e6;
            margin: 16px 0;
        }

        .guarantee-checkout {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
            text-align: left;
            margin-bottom: 8px;
        }

        .guarantee-methods {
            text-align: left;
        }

        .apple-pay-button {
            width: 100%;
            height: 50px;
            background: #000;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .apple-pay-button:hover {
            background: #333;
        }

        .apple-pay-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 500;
            color: #212529;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .pay-button {
            width: 100%;
            height: 50px;
            background: #000;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .pay-button:hover {
            background: #333;
        }

        .pay-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .security-note {
            text-align: center;
            font-size: 12px;
            color: #212529;
            margin-top: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }

        .success-message {
            color: #28a745;
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }

        /* Stripe Elements styling */
        .StripeElement {
            background-color: white;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
            width: 100%;
            box-sizing: border-box;
        }

        .StripeElement--focus {
            border-color: #667eea;
            outline: none;
        }

        .StripeElement--invalid {
            border-color: #dc3545;
        }

        .StripeElement--complete {
            border-color: #28a745;
        }

        /* Mobile responsiveness */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .payment-header h1 {
                font-size: 20px;
            }
            
            .total-section {
                padding: 12px 16px 12px 0;
            }
            
            .payment-method-header {
                padding: 16px;
            }
            
            .payment-method-content.active {
                padding: 16px;
            }
            
            .form-group {
                margin-bottom: 12px;
            }
            
            .form-input {
                padding: 10px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .apple-pay-button,
            .pay-button {
                height: 48px;
                font-size: 16px;
            }
            
            .guarantee-section {
                padding: 16px;
            }
            
            .guarantee-title {
                font-size: 14px;
            }
            
            .guarantee-text {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="payment-header">
            <h1>Payment method</h1>
        </div>
        

        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <div>Loading payment options...</div>
        </div>

        <div class="payment-methods" id="paymentMethods">
            <!-- Apple Pay Method (First) -->
            <div class="payment-method">
                <div class="payment-method-header" onclick="togglePaymentMethod('applePay')">
                    <div class="payment-method-radio" id="applePayRadio"></div>
                    <div class="payment-method-title">Apple Pay</div>
                    <div class="payment-method-badge">
                        <img src="img/icons8-apple-inc-90.png" alt="Apple" style="width: 20px; height: 20px; margin-right: 4px;">
                        <span>Pay</span>
                    </div>
                </div>
                <div class="payment-method-content" id="applePayContent">
                    <div class="total-section">
                        <div class="total-label">Total Today</div>
                        <div class="total-amount" id="applePayAmount">$4.99</div>
                    </div>
                    <button class="apple-pay-button" id="applePayButton">
                        <span>Pay with</span>
                        <img src="img/icons8-apple-inc-90.png" alt="Apple" style="width: 16px; height: 16px; margin: 0 -2px 0 0; filter: brightness(0) invert(1);">
                        <span>Pay</span>
                    </button>
                    <div class="success-message" id="applePaySuccess"></div>
                    <div class="security-note">
                        Your payment information is secure with SSL/TLS encryption
                    </div>
                </div>
            </div>

            <!-- Credit Card Method (Second, Active by default) -->
            <div class="payment-method active">
                <div class="payment-method-header" onclick="togglePaymentMethod('creditCard')">
                    <div class="payment-method-radio active" id="creditCardRadio"></div>
                    <div class="payment-method-title">Credit card</div>
                    <div class="payment-method-badge">
                        <img src="img/methods.png" alt="Payment Methods" style="height: 26px;">
                    </div>
                </div>
                <div class="payment-method-content active" id="creditCardContent">
                    <div class="total-section">
                        <div class="total-label">Total Today</div>
                        <div class="total-amount" id="creditCardAmount">$4.99</div>
                    </div>
                    <form id="paymentForm">
                        <div class="form-group">
                            <label class="form-label">Card number</label>
                            <div id="card-element" class="form-input">
                                <!-- Stripe Elements will create form elements here -->
                            </div>
                            <div class="error-message" id="card-errors"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Expiry (MM/YY)</label>
                                <div id="expiry-element" class="form-input">
                                    <!-- Stripe Elements will create form elements here -->
                                </div>
                                <div class="error-message" id="expiry-errors"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CVV</label>
                                <div id="cvv-element" class="form-input">
                                    <!-- Stripe Elements will create form elements here -->
                                </div>
                                <div class="error-message" id="cvv-errors"></div>
                            </div>
                        </div>
                        <button type="submit" class="pay-button" id="payButton">
                            Pay
                        </button>
                        <div class="error-message" id="errorMessage"></div>
                        <div class="success-message" id="successMessage"></div>
                    </form>
                    <div class="security-note">
                        Your payment information is secure with SSL/TLS encryption
                    </div>
                </div>
            </div>
        </div>

        <!-- Guarantee Section -->
        <div class="guarantee-section">
            <img src="img/money-back-guarantee.webp" alt="Money Back Guarantee" style="width: 80px; height: 80px; margin: 0 0 16px 0; display: block;">
            <div class="guarantee-title">100% Money-Back Guarantee</div>
            <div class="guarantee-text">
                We're so confident that Zing Coach can help you improve your fitness that we'll return your money if you don't see visible results in 4 weeks (and can prove that you followed our plan).
            </div>
            <div class="guarantee-divider"></div>
            <div class="guarantee-checkout">Guaranteed Safe Checkout</div>
            <div class="guarantee-methods">
                <img src="img/methods.png" alt="Payment Methods" style="height: 26px;">
            </div>
        </div>
    </div>

    <script>
        // Initialize Stripe
        const stripe = Stripe('pk_live_51Qk1KmK2gOb0VfuWz5unqlgduUQKZTOXnSFR35DiEyKiqtABb4V8xgmr8TQ4QrvSE02Ct2Ue5CXYZBBgtBf2NRr300I4RzjW4h');
        
        let currentPrice = 4.99; // Weekly plan price
        let currentPriceId = null; // Weekly plan price ID
        let isApplePayAvailable = false;
        let elements;
        let cardElement;
        let expiryElement;
        let cvvElement;
        let serverPublishableKey = null;
        let serverPlans = null;

        // API base URL - same as palmreader
        const API_BASE_URL = 'https://ydtsxivmnq.us-east-1.awsapprunner.com';

        // Fetch price from backend using product ID
        async function fetchPrice() {
            try {
                console.log('Fetching price for product prod_SyP5N4rFJXv4cL...');
                
                // Get products using the real product ID
                const productsResponse = await fetch(`${API_BASE_URL}/api/products?weekly=prod_SyP5N4rFJXv4cL&monthly=prod_SyP5N4rFJXv4cL&yearly=prod_SyP5N4rFJXv4cL`);
                
                if (productsResponse.ok) {
                    const productsData = await productsResponse.json();
                    console.log('Products loaded:', productsData);
                    
                    if (productsData.plans && productsData.plans.weekly) {
                        const weeklyPlan = productsData.plans.weekly;
                        currentPrice = weeklyPlan.unitAmount / 100; // Convert from cents
                        currentPriceId = weeklyPlan.priceId;
                        
                        console.log('Price set from server:', currentPrice);
                        console.log('Price ID set from server:', currentPriceId);
                        document.getElementById('applePayAmount').textContent = `$${currentPrice.toFixed(2)}`;
                        document.getElementById('creditCardAmount').textContent = `$${currentPrice.toFixed(2)}`;
                        
                        // Enable payment buttons if price > 0
                        if (currentPrice > 0) {
                            document.getElementById('applePayButton').disabled = false;
                            document.getElementById('payButton').disabled = false;
                        }
                    } else {
                        throw new Error('No weekly plan found in response');
                    }
                } else {
                    const errorData = await productsResponse.json();
                    console.error('API error:', errorData);
                    throw new Error(`API error: ${errorData.error?.message || 'Unknown error'}`);
                }
                
                // Hide loading spinner
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error setting price:', error);
                console.log('Using fallback price: $0.00');
                
                // Fallback price - $0 if product not found
                currentPrice = 0.00;
                currentPriceId = null; // No price ID if product not found
                document.getElementById('applePayAmount').textContent = `$${currentPrice.toFixed(2)}`;
                document.getElementById('creditCardAmount').textContent = `$${currentPrice.toFixed(2)}`;
                
                // Disable payment buttons if price is $0
                if (currentPrice === 0) {
                    document.getElementById('applePayButton').disabled = true;
                    document.getElementById('payButton').disabled = true;
                    console.log('Payment buttons disabled - no product found');
                }
                
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Initialize Stripe Elements
        function initializeStripeElements() {
            elements = stripe.elements();
            
            // Create card number element
            cardElement = elements.create('cardNumber', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#212529',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                        '::placeholder': {
                            color: '#6c757d',
                        },
                    },
                },
            });
            cardElement.mount('#card-element');
            
            // Create expiry element
            expiryElement = elements.create('cardExpiry', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#212529',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                        '::placeholder': {
                            color: '#6c757d',
                        },
                    },
                },
            });
            expiryElement.mount('#expiry-element');
            
            // Create CVV element
            cvvElement = elements.create('cardCvc', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#212529',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                        '::placeholder': {
                            color: '#6c757d',
                        },
                    },
                },
            });
            cvvElement.mount('#cvv-element');
            
            // Handle real-time validation errors from the card Element
            cardElement.on('change', function(event) {
                const displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                    displayError.style.display = 'block';
                    cardComplete = false;
                } else {
                    displayError.textContent = '';
                    displayError.style.display = 'none';
                    cardComplete = event.complete;
                }
                checkFormCompletion();
            });
            
            expiryElement.on('change', function(event) {
                const displayError = document.getElementById('expiry-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                    displayError.style.display = 'block';
                    expiryComplete = false;
                } else {
                    displayError.textContent = '';
                    displayError.style.display = 'none';
                    expiryComplete = event.complete;
                }
                checkFormCompletion();
            });
            
            cvvElement.on('change', function(event) {
                const displayError = document.getElementById('cvv-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                    displayError.style.display = 'block';
                    cvvComplete = false;
                } else {
                    displayError.textContent = '';
                    displayError.style.display = 'none';
                    cvvComplete = event.complete;
                }
                checkFormCompletion();
            });
            
            // Enable pay button after elements are mounted
            checkFormCompletion();
        }

        // Initialize Apple Pay
        function initializeApplePay() {
            console.log('üîç Initializing Apple Pay...');
            
            // Check if Apple Pay is available
            if (window.ApplePaySession && ApplePaySession.canMakePayments()) {
                isApplePayAvailable = true;
                console.log('‚úÖ Apple Pay is available and ready');
            } else {
                isApplePayAvailable = false;
                console.log('‚ùå Apple Pay is not available');
                // Hide Apple Pay button if not available
                const applePayButton = document.getElementById('applePayButton');
                if (applePayButton) {
                    applePayButton.style.display = 'none';
                }
            }
        }

        // Toggle payment method sections
        function togglePaymentMethod(method) {
            const content = document.getElementById(method + 'Content');
            const radio = document.getElementById(method + 'Radio');
            const methodElement = radio.closest('.payment-method');
            
            // Close all other methods
            document.querySelectorAll('.payment-method-content').forEach(el => {
                if (el !== content) {
                    el.classList.remove('active');
                }
            });
            
            // Remove active state from all radios and method containers
            document.querySelectorAll('.payment-method-radio').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('active');
            });
            
            // Toggle current method
            content.classList.toggle('active');
            radio.classList.toggle('active');
            methodElement.classList.toggle('active');
            
            // Initialize Apple Pay when Apple Pay section is clicked
            if (method === 'applePay') {
                console.log('üçé Apple Pay section clicked - initializing...');
                initializeApplePayPayment();
            }
        }

        // Apple Pay variables
        let isApplePayProcessing = false;
        let applePayPaymentRequest = null;
        
        // Function to initialize Apple Pay when section is clicked
        function initializeApplePayPayment() {
            console.log('üîß Initializing Apple Pay payment...');
            console.log('Current price:', currentPrice);
            console.log('Current protocol:', window.location.protocol);
            console.log('Current hostname:', window.location.hostname);
            console.log('User agent:', navigator.userAgent);
            
            // Check if we're on HTTPS or localhost
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                console.error('Apple Pay requires HTTPS or localhost');
                alert('Apple Pay requires HTTPS or localhost. Current protocol: ' + window.location.protocol);
                return;
            }
            
            // Check if price is valid
            if (!currentPrice || currentPrice <= 0) {
                console.error('Invalid price for Apple Pay:', currentPrice);
                alert('Invalid price for Apple Pay');
                return;
            }
            
            // Check if priceId is available
            if (!currentPriceId) {
                console.error('No price ID available for Apple Pay');
                alert('No price ID available for Apple Pay');
                return;
            }
            
            try {
                // Create payment request
                applePayPaymentRequest = stripe.paymentRequest({
                    country: 'US',
                    currency: 'usd',
                    total: {
                        label: 'Weekly Plan',
                        amount: Math.round(currentPrice * 100), // Convert to cents
                    },
                    requestPayerName: true,
                    requestPayerEmail: true,
                });
                
                console.log('üìã Payment request created');
                
                // Handle Apple Pay events
                applePayPaymentRequest.on('cancel', () => {
                    console.log('üö´ Apple Pay cancelled');
                    // Reset processing flag
                    isApplePayProcessing = false;
                });
                
                // Handle payment method
                applePayPaymentRequest.on('paymentmethod', async (ev) => {
                    console.log('üí≥ Apple Pay payment authorized');
                    
                    try {
                        // Create subscription on server
                        const requestData = {
                            priceId: currentPriceId,
                            email: ev.payerEmail || 'noemail@example.com',
                            paymentMethodId: ev.paymentMethod.id,
                        };
                        console.log('Apple Pay request data:', requestData);
                        
                        const response = await fetch(`${API_BASE_URL}/api/create-subscription`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestData),
                        });
                        
                        console.log('Apple Pay server response status:', response.status);
                        const result = await response.json();
                        console.log('Apple Pay server response:', result);
                        
                        if (result.error) {
                            console.error('Apple Pay server error:', result.error);
                            ev.complete('fail');
                            showApplePayError('Payment failed: ' + (result.error.message || JSON.stringify(result.error)));
                            return;
                        }
                        
                        // Confirm payment
                        ev.complete('success');
                        
                        // Track analytics
                        trackPurchase('apple_pay', currentPrice);
                        showApplePaySuccess('Payment successful! Thank you for your purchase.');
                    } catch (error) {
                        console.error('Apple Pay payment error:', error);
                        ev.complete('fail');
                        showApplePayError('Payment failed: ' + error.message);
                    } finally {
                        // Reset processing flag
                        isApplePayProcessing = false;
                    }
                });
                
                console.log('‚úÖ Apple Pay payment initialized successfully');
                
            } catch (error) {
                console.error('Apple Pay setup error:', error);
                alert('Apple Pay setup error: ' + error.message);
            }
        }
        
        // Function to handle Apple Pay button click (just show the window)
        function handleApplePayClick() {
            console.log('üçé Apple Pay button clicked');
            
            // Prevent multiple clicks
            if (isApplePayProcessing) {
                console.log('Apple Pay already processing...');
                return;
            }
            
            // Check if payment request is initialized
            if (!applePayPaymentRequest) {
                console.error('Apple Pay not initialized');
                alert('Apple Pay not initialized. Please click on the Apple Pay section first.');
                return;
            }
            
            isApplePayProcessing = true;
            
            try {
                // Check availability and show
                applePayPaymentRequest.canMakePayment().then(function(result) {
                    console.log('üîç Apple Pay canMakePayment result:', result);
                    if (result) {
                        console.log('üé¨ Showing Apple Pay sheet...');
                        try {
                            applePayPaymentRequest.show();
                            console.log('‚úÖ Apple Pay sheet shown successfully');
                            // Reset processing flag
                            isApplePayProcessing = false;
                        } catch (showError) {
                            console.error('‚ùå Error showing Apple Pay:', showError);
                            alert('Error showing Apple Pay: ' + showError.message);
                            // Reset processing flag
                            isApplePayProcessing = false;
                        }
                    } else {
                        console.log('Apple Pay not available');
                        alert('Apple Pay is not available on this device');
                        // Reset processing flag
                        isApplePayProcessing = false;
                    }
                }).catch(function(error) {
                    console.error('Apple Pay error:', error);
                    alert('Apple Pay error: ' + error.message);
                    // Reset processing flag
                    isApplePayProcessing = false;
                });
                
            } catch (error) {
                console.error('Apple Pay show error:', error);
                alert('Apple Pay show error: ' + error.message);
                // Reset processing flag
                isApplePayProcessing = false;
            }
        }
        
        // Add event listener to Apple Pay button
        document.getElementById('applePayButton').addEventListener('click', handleApplePayClick);

        // Credit card form handling
        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Enable pay button
            document.getElementById('payButton').disabled = true;
            document.getElementById('payButton').textContent = 'Processing...';
            
            try {
                // Create payment method using Stripe Elements
                const {error, paymentMethod} = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                });
                
                if (error) {
                    showError(error.message);
                    return;
                }
                
                // Create subscription on server
                const requestData = {
                    priceId: currentPriceId, // Use price ID from product, or null if not found
                    email: 'noemail@example.com', // You can add email input if needed
                    paymentMethodId: paymentMethod.id,
                };
                console.log('Credit card request data:', requestData);
                
                const response = await fetch(`${API_BASE_URL}/api/create-subscription`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                });
                
                console.log('Server response status:', response.status);
                const result = await response.json();
                console.log('Server response:', result);
                
                if (result.error) {
                    console.error('Server error:', result.error);
                    throw new Error(result.error.message || JSON.stringify(result.error));
                }
                
                // Track successful purchase
                trackPurchase('credit_card', currentPrice);
                showSuccess('Payment successful! Thank you for your purchase.');
                
            } catch (error) {
                console.error('Payment error:', error);
                showError('Payment failed. Please try again.');
            } finally {
                document.getElementById('payButton').disabled = false;
                document.getElementById('payButton').textContent = 'Pay';
            }
        });

        // Check form completion for Stripe Elements
        function checkFormCompletion() {
            // Enable button when all elements are complete and valid
            const isComplete = cardComplete && expiryComplete && cvvComplete;
            document.getElementById('payButton').disabled = !isComplete;
        }
        
        // Track completion state of each element
        let cardComplete = false;
        let expiryComplete = false;
        let cvvComplete = false;

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';
        }


        function showApplePaySuccess(message) {
            const successDiv = document.getElementById('applePaySuccess');
            
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }

        function showApplePayError(message) {
            const errorDiv = document.getElementById('applePaySuccess');
            
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.color = '#dc3545';
        }

        // Analytics tracking function
        function trackPurchase(paymentMethod, amount) {
            const eventData = {
                payment_method: paymentMethod,
                amount: amount,
                currency: 'USD',
                timestamp: new Date().toISOString()
            };
            
            // Track in Mixpanel
            if (typeof mixpanel !== 'undefined') {
                mixpanel.track('purchase', eventData);
            }
            
            // Track in Facebook Pixel (using built-in purchase event)
            if (typeof fbq !== 'undefined') {
                fbq('track', 'Purchase', {
                    value: amount,
                    currency: 'USD',
                    content_type: 'subscription',
                    content_name: 'Room Design Quiz Subscription'
                });
            }
        }
        
        function trackPaymentError(paymentMethod, errorMessage, errorCode) {
            const eventData = {
                payment_method: paymentMethod,
                error_message: errorMessage,
                error_code: errorCode,
                timestamp: new Date().toISOString()
            };
            
            // Track in Mixpanel
            if (typeof mixpanel !== 'undefined') {
                mixpanel.track('payment_error', eventData);
            }
            
            // Track in Facebook Pixel
            if (typeof fbq !== 'undefined') {
                fbq('track', 'payment_error', eventData);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Show loading spinner
            document.getElementById('loading').style.display = 'block';
            
            // Set initial fallback price
            currentPrice = 0.00;
            currentPriceId = null; // Will be set when product is loaded
            
            // Fetch price from product first
            await fetchPrice();
            
            // Initialize Stripe Elements after price is loaded
            initializeStripeElements();
            
            // Initialize Apple Pay
            initializeApplePay();
        });
    </script>
</body>
</html>
